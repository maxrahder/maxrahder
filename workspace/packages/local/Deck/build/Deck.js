Ext.define("Deck.model.IdGenerator",{extend:"Ext.data.identifier.Generator",alias:"data.identifier.fileid",suffix:0,generate:function(){var a=Ext.Date.format(new Date(),"C").replace(/\.|\:/g,"-");if(a===this.previous){a+=("-"+ ++this.suffix)}else{this.suffix=0;this.previous=a}return a}});Ext.define("Deck.model.MarkedOverrides",{requires:[],singleton:true,constructor:function(){var a=this;marked.InlineLexer.prototype.outputSave=marked.InlineLexer.prototype.output;var b=["doCallouts"];marked.InlineLexer.prototype.output=function(c){for(var d=0;d<b.length;d++){c=a[b[d]](c)}return this.outputSave(c)}},calloutCss:{"TIP:":"tip","NOTE:":"note","WARNING:":"warning","STOP:":"caution","EXPERIMENT:":"experiment"},callouts:["TIP:","NOTE:","WARNING:","STOP:","EXPERIMENT:"],calloutHtml:'<div class="block"><span class="{0} content">{1}</span></div>',doCallouts:function(b){for(var d=0;d<this.callouts.length;d++){var e=this.callouts[d];if(b.startsWith(e)){var a=this.calloutCss[e].toLowerCase();return Ext.String.format(this.calloutHtml,a,b.substr(e.length))}}return b},expanderRe:/<div.*expander.*caption="(.*)".*>/,olStep:/(^\?\?)(.*)(\n\.\n)([^]*)/,olEndStep:/(.*)(\n\.\.$)/,doOlStep:function(b){var a=b;a=a.replace(this.olStep,function(f,g,e,d,c){return'<div class="expander collapsed"><span class="expandertitle">'+e+'</span><div class="content"><p>'+c+"</p>"});a=a.replace(this.olEndStep,function(d,e,c){return e+"</div></div>"});return a}});Ext.define("Deck.util.Global",{singleton:true,editing:location.search.match(/\edit\b/),constructor:function(){this.language="_default";if(location.search){var a=Ext.Object.fromQueryString(location.search[1]);this.language=(a.language||this.language)}this.callParent(arguments)},rightShift:function(e,b){b=(b%e.length);var d=_.first(e,b);var c=_.last(e,(e.length-b));var a=c.concat(d);return a},testShiftArray:function(){var b=[1,2,3,4,5];console.log(Ext.Array.equals(Deck.util.Global.rightShift(b,0),[1,2,3,4,5]));console.log(Ext.Array.equals(Deck.util.Global.rightShift(b,1),[2,3,4,5,1]));console.log(Ext.Array.equals(Deck.util.Global.rightShift(b,2),[3,4,5,1,2]));console.log(Ext.Array.equals(Deck.util.Global.rightShift(b,3),[4,5,1,2,3]));console.log(Ext.Array.equals(Deck.util.Global.rightShift(b,4),[5,1,2,3,4]));console.log(Ext.Array.equals(Deck.util.Global.rightShift(b,5),[1,2,3,4,5]));console.log(Ext.Array.equals(Deck.util.Global.rightShift(b,6),[2,3,4,5,1]))},getNext:function(c,f,e){e=Ext.isDefined(e)?e:true;var d=Ext.Array.indexOf(c,f);var b=null;if(c.length===0){}else{if(d===-1){}else{if(e){if(d<(c.length-1)){b=c[d+1]}else{b=c[0]}}else{if(d>0){b=c[d-1]}else{b=c[c.length-1]}}}}return b},testGetNext:function(){var b=[1,2,3,4,5];console.log(Deck.util.Global.getNext(b,1,true)===2);console.log(Deck.util.Global.getNext(b,2,true)===3);console.log(Deck.util.Global.getNext(b,3,true)===4);console.log(Deck.util.Global.getNext(b,4,true)===5);console.log(Deck.util.Global.getNext(b,5,true)===1);console.log(Deck.util.Global.getNext(b,6,true)===null);console.log(Deck.util.Global.getNext(b,1)===2);console.log(Deck.util.Global.getNext(b,2)===3);console.log(Deck.util.Global.getNext(b,3)===4);console.log(Deck.util.Global.getNext(b,1,false)===5);console.log(Deck.util.Global.getNext(b,2,false)===1);console.log(Deck.util.Global.getNext(b,3,false)===2);console.log(Deck.util.Global.getNext(b,4,false)===3);console.log(Deck.util.Global.getNext(b,5,false)===4);console.log(Deck.util.Global.getNext(b,6,false)===null)}});Ext.define("Deck.util.Backend",{extend:"Ext.Mixin",singleton:true,constructor:function(){this.callParent(arguments);this.persistNodeBuffered=Ext.Function.createBuffered(this.persistNode,1000,this);this.saveTreeBuffered=Ext.Function.createBuffered(this.saveTree,1000,this)},saveTree:function(d){var c=this;var a=d.getHierarchy();var b={url:"http://localhost:3000/saveTree",jsonData:{data:Ext.JSON.encode(a)}};c._send(b,"Tree hierarchy")},openInEditor:function(d,c){var b=this;var a={url:"http://localhost:3000/openInEditor",jsonData:{id:d,language:c}};b._send(a,"Open "+d)},persistContent:function(e,c,d){var b=this;d=(d||"_default");c=(c||"");var a={url:"http://localhost:3000/saveContent",jsonData:{id:e,data:c,language:d}};b._send(a,"Content "+e)},persistNode:function(c){var b=this;console.log("persistNode");if(!c){return}var d={id:c.data.id,i18n:Ext.clone(c.data.i18n),leaf:c.isLeaf()};if(!c.isLeaf()&&c.childNodes){d.children=[];Ext.Array.forEach(c.childNodes,function(e){d.children.push(e.data.id)})}var a={url:"http://localhost:3000/saveNode",jsonData:{id:c.data.id,data:Ext.JSON.encode(d)}};b._send(a,("Node "+c.data.id))},_send:function(a,b){Ext.apply(a,{method:"POST"});Ext.apply(a.jsonData,{app:Ext.manifest.name});Ext.Ajax.request(a).then(function(c){Ext.toast({title:"Saved",html:b+" was saved.",width:250,align:"tr"})},function(c){if(c.status===0){Ext.toast("Did you start the Node server?","Error Saving")}else{Ext.toast(c.statusText,"Error Saving "+b+" was not saved.")}})}});Ext.define("Deck.model.Node",{extend:"Ext.data.TreeModel",requires:["Deck.model.IdGenerator","Deck.util.Global","Deck.util.Backend"],statics:{cache:{},getCachedContent:function(a){return Deck.model.Node.cache[a]}},identifier:{type:"fileid"},fields:["i18n",{name:"text",convert:function(d,b){var c=b.data.i18n;if(!c){return""}var a;var e=b.data.language;if(c[e]){a=c[e].title}a=(a||b.data.i18n._default.title);return a},depends:["language","i18n"]},{name:"language",defaultValue:"_default"},{name:"leaf",convert:function(b,a){return a.data.leaf||!a.data.children}}],updateText:function(c){var a=this;var d=a.data.language;if(a.data.language){if(a.data.i18n[d].title===c){return}}else{if(a.data.i18n._default.title===c){return}}var b=Ext.clone(a.data.i18n);b[d]=b[d]||{persisted:false,title:""};b[d].title=c;a.set("i18n",b)},getPersistableNode:function(){var a={id:node.data.id,i18n:Ext.clone(node.data.i18n),leaf:node.isLeaf()};if(!node.isLeaf()&&node.childNodes){a.children=[];Ext.Array.forEach(node.childNodes,function(b){a.children.push(b.data.id)})}},getContent:function(){var c=this;var b=Ext.create("Ext.Deferred");if(!c.isRoot()&&c.isLeaf()){a()}else{b.resolve(c.data.text)}return b.promise;function a(){var g=Deck.util.Global.language;var e=c.data.i18n;var d=c.data.id;var f="";if(f){b.resolve(f)}else{if(d){Ext.Ajax.request({url:("resources/pages/content/_default/"+d+".md")}).then(function(h){f=h.responseText;f=marked(f);c.cacheContent(f);b.resolve(f)},function(h){b.reject(h)})}else{b.resolve("")}}}},persistNode:function(){Deck.util.Backend.persistNode(this)},persistContent:function(a){lanuage=a||"_default"},cacheContent:function(a){if(this.data.id){Deck.model.Node.cache[this.data.id]=a}},isLab:function(){return(this.data.text.substr(0,4)==="Lab:")},getParentTitles:function(){var a=[];var b=this;while(b){a.push(b.getText());b=b.parentNode}return a}});Ext.define("Deck.store.Topics",{extend:"Ext.data.TreeStore",alias:"store.deck-topics",requires:["Deck.util.Backend"],model:"Deck.model.Node",statics:{loadNodes:function(a){var c=this;var b=new Ext.Deferred();c._loadNodes(a).then(function(d,e){console.log("tree.json does not exist. Building tree.");b.resolve(d,e)},function(){console.log("Failure creating tree from _loadNotes");b.reject()});return b},_loadNodes:function(c){var f=this;c=(c||[]);var d=new Ext.Deferred();var h={};var b=[];var e=0;a(h,"_root",c);return d;function a(l,m,i){var k=this;e++;var j="resources/pages/nodes/"+m+".json";Ext.Ajax.request({url:j,node:l,success:function(n,o){var q=Ext.JSON.decode(n.responseText);var r=o.node;Ext.apply(r,q);if(r.children){var t=Ext.Array.clone(r.children);r.children=[];for(var p=0;p<t.length;p++){var s=t[p];if(Ext.Array.contains(i,s)){console.log("Skipping "+s)}else{var u={};r.children.push(u);a(u,s,i)}}}g()},failure:function(n,o){if(n.status===404){b.push(m)}console.log("Dangling reference. Failed to read "+m+" under "+l.fileId);console.log(l);console.log(n);g()}})}function g(){var i=this;e--;if(e===0){d.resolve(h,b)}}}},getNodeArray:function(b){var c=this;b=!!b;if(b||!c._nodeArray){c._nodeArray=[];var a=c.getRoot();a.cascadeBy(function(d){if(!d.isRoot()){c._nodeArray.push(d)}})}return c._nodeArray},findNextOrPrevious:function(e,d){d=Ext.isBoolean(d)?d:true;var c=Ext.Array.indexOf(this.getNodeArray(),e);if(c===-1){return null}else{var b=this.getNodeArray();if(d){result=((c===(b.length-1))?b[0]:b[c+1])}else{result=((c===0)?b[b.length-1]:b[c-1])}}return result},findNode:function(d,f,c){c=Ext.isDefined(c)?c:true;var g=c?this.getNodeArray():this.getNodeArray().slice().reverse();var b=g.indexOf(d);g=Deck.util.Global.rightShift(g,b+1);var e=new RegExp(f.trim(),"i");var a=Ext.Array.findBy(g,function(h){return(h.data.id.match(e)||h.data.text.match(e))});return a},getNext:function(e,d){var c=this.getNodeArray();var b=Deck.util.Global.getNext(c,e,d);return b},getHierarchy:function(){var b=this.getRoot();var a={};c(b,a);return a;function c(h,e){e.id=h.data.id;e.i18n=Ext.clone(h.data.i18n);if(!h.isLeaf()){e.children=[];for(var g=0;g<h.childNodes.length;g++){var f=h.childNodes[g];var d={};e.children.push(d);c(f,d)}}}}});Ext.define("Deck.view.content.ContentController",{extend:"Ext.app.ViewController",alias:"controller.deck-content",onKeyMap:function(a,b){this.fireViewEvent("navigate",a)}});Ext.define("Deck.view.content.ContentMethods",{extend:"Ext.Mixin",requires:["EditView.view.editview.PreTagEditAndView"],updateNode:function(c){var b=this;if(!c){return}if(c.isLeaf()){c.getContent().then(function(d){b.updateContent(d,c)},function(){console.log("Failure reading "+c.id);console.log(arguments)})}else{var a=["<img style='height: 60%; display: block; margin: 3em auto 0 auto; ' src='resources/images/senchaleaf.svg'></img>"];b.update(a.join(""),c)}b.lookup("breadcrumb").setSelection(c)},updateContent:function(c,e){var d=this;d.suspendEvents();d.getEl().select("div.expander",true).clearListeners();d.setHtml(c);if(e.isLab()){d.getEl().down("div.x-panel-body").addCls("lab")}d.setupExpanders(d,e);d.preTags=d.preTags||[];d.preTags=[];var b=d.getEl().query("pre.runnable");Ext.Array.forEach(b,function(f){var a=Ext.create("EditView.view.editview.PreTagEditAndView",{style:"border: thin solid #eeeeee",pre:f,renderTo:f});d.preTags.push(a)});d.scrollTo(0,0);d.resumeEvents()},setupExpanders:function(f,e){var b=f.getEl().query('div[type="expander"]');if(e.isLab()){var c=true;var d=0}Ext.Array.forEach(b,function(k){var j=document.createElement("div");var i=Ext.get(j);i.addCls("expander collapsed");var g=Ext.fly(k).getAttributes();var a=document.createElement("span");Ext.fly(a).addCls("expandertitle");a.innerHTML=(c?(++d+".&nbsp;"):"")+g.caption;var h=document.createElement("div");Ext.fly(h).addCls("content");h.innerHTML=k.innerHTML;j.append(a);j.append(h);Ext.get(a).on("click",function(){if(i.hasCls("collapsed")){i.removeCls("collapsed");i.addCls("expanded")}else{i.addCls("collapsed");i.removeCls("expanded")}});k.parentNode.replaceChild(j,k)})}});Ext.define("Deck.view.content.Content",{xtype:"deck-content",extend:"Ext.panel.Panel",requires:["Deck.view.content.ContentController"],mixins:["Deck.view.content.ContentMethods"],controller:"deck-content",renderConfig:{node:null},cls:"deckcontentview",bodyPadding:8,scrollable:true,layout:"fit",dockedItems:[{xtype:"toolbar",items:[{xtype:"breadcrumb",reference:"breadcrumb",bind:{store:"{topics}"}},"->",{xtype:"button",iconCls:"x-fa fa-arrows-h",tooltip:"Focus for arrow key navigation",keyMap:{RIGHT:"onKeyMap",LEFT:"onKeyMap",UP:"onKeyMap",DOWN:"onKeyMap"}}]},{xtype:"component",dock:"top",itemId:"title",reference:"title",cls:"title",tpl:"{text}",height:48,bind:{data:"{node.text}"}}]});Ext.define("Deck.view.edit.ToolbarController",{extend:"Ext.app.ViewController",alias:"controller.edit-toolbar",requires:["Deck.util.Backend"],init:function(){var a=this},initViewModel:function(a){var b=this;a.bind("{node.text}",function(c){b.lookup("nodeTitle").setValue(c)});a.bind("{topics}",function(c){c.on("update",b.onTopicsUpdate,b)})},onTopicsUpdate:function(c,a,b,d){if(!d){return}if(Ext.Array.contains(d,"children")){console.log("children changed")}else{if(Ext.Array.contains(d,"i18n")){Deck.util.Backend.persistNodeBuffered(a);Deck.util.Backend.saveTreeBuffered(this.getViewModel().get("topics"))}}},onTitleChange:function(c,b){var a=this;node=a.getViewModel().get("node");node.updateText(b)},onCreateLeaf:function(a){this.fireViewEvent("createleaf")},onCreateTopic:function(a){this.fireViewEvent("createtopic")},onEditPage:function(a){this.fireViewEvent("editpage")},onRefresh:function(a){this.fireViewEvent("refresh")}});Ext.define("Deck.view.edit.ToolbarModel",{extend:"Ext.app.ViewModel",alias:"viewmodel.edit-toolbar",data:{name:"Foo"}});Ext.define("Deck.view.edit.Toolbar",{xtype:"edittoolbar",extend:"Ext.toolbar.Toolbar",requires:["Deck.view.edit.ToolbarController","Deck.view.edit.ToolbarModel"],controller:"edit-toolbar",viewModel:{type:"edit-toolbar"},renderConfig:{language:"_default"},publishes:["language"],items:[{xtype:"segmentedbutton",value:"_default",bind:{value:"{language}"},items:[{text:"US",value:"_default"},{text:"FR",value:"fr-FR"},{text:"JP",value:"jp-JP"}],margin:1},{xtype:"tbspacer",width:16},{xtype:"button",iconCls:"x-fa fa-folder-o",text:"Add Topic",handler:"onCreateTopic"},{xtype:"textfield",width:300,labelWidth:60,fieldLabel:"Topic title",reference:"nodeTitle",bind:{value:"{node.title}"},listeners:{change:"onTitleChange"}},{xtype:"tbspacer",width:16},{xtype:"button",iconCls:"x-fa fa-file-o",text:"Add Page",handler:"onCreateLeaf"},{text:"Edit Page",iconCls:"x-fa fa-external-link",handler:"onEditPage"},{text:"Refresh Page",iconCls:"x-fa fa-refresh",handler:"onRefresh"}]});Ext.define("Deck.view.main.Editing",{extend:"Ext.Mixin",requires:["Ext.tree.plugin.TreeViewDragDrop","Deck.util.Backend"],initComponentEditing:function(a){if(!Deck.util.Global.editing){return}var c=this;a.addDocked({xtype:"edittoolbar",listeners:{refresh:"onRefresh",editpage:"onEditPage",createleaf:"onCreateLeaf",createtopic:"onCreateTopic"}});var b=this.lookup("treePanel");b.getView().addPlugin({ptype:"treeviewdragdrop"});b.on("itemmove",c.onItemMove,c)},onRefresh:function(){var a=this.getViewModel().get("node");if(a){console.log("refresh");this.lookup("content").updateNode(a)}},initViewModelEditing:function(a){if(!Deck.util.Global.editing){return}a.bind("{topics}",function(b){Deck.util.Backend.saveTreeBuffered(b)})},onEditPage:function(){var a=this.getViewModel();var b=a.get("node");var c=a.get("language")||"_default";if(b){if(b.isLeaf()){Deck.util.Backend.openInEditor(b.data.id,c)}else{Ext.toast("Editing pages only applies to leaves.","Warning")}}},_createNode:function(b){console.log("createNode");var f=this;var d=this.getViewModel();var e=d.get("node");if(e){var c=Ext.create("Deck.model.Node",b);var a=e.parentNode.indexOf(e);if(e.isLeaf()){e.parentNode.insertChild((a+1),c)}else{e.appendChild(c)}Deck.util.Backend.persistNode(c.parentNode);Deck.util.Backend.persistNode(c);return c}},onCreateLeaf:function(){var a=this._createNode({i18n:{_default:{title:"New Node",translated:true}}});Deck.util.Backend.persistContent(a.data.id)},onCreateTopic:function(){this._createNode({i18n:{_default:{title:"New Topic"}},children:[]})},onItemMove:function(e,c,d,a,b){if(c===d){Deck.util.Backend.persistNode(c)}else{Deck.util.Backend.persistNode(c);Deck.util.Backend.persistNode(d)}Deck.util.Backend.saveTreeBuffered(this.getViewModel().get("topics"));this.getViewModel().get("topics").getNodeArray(true)}});Ext.define("Deck.view.main.MainViewController",{extend:"Ext.app.ViewController",alias:"controller.maincontroller",mixins:["Deck.view.main.Editing"],requires:["Deck.store.Topics","Deck.model.Node"],routes:{":id":"processRoute"},processRoute:function(c){var b=this;if(c){var a=b.getNode();if(a&&(a.data.id!==c)){b.goToPage(b.getViewModel().get("topics"),c)}}},getNode:function(){if(this.vm){if(this.vm.get("node")){return this.vm.get("node")}}},init:function(a){this.initComponentEditing(a)},initViewModel:function(a){var b=this;b.vm=a;b.initViewModelEditing(a);b.initializeTopics();a.bind("{node}",b.nodeChange,b);a.bind("{topics}",function(c){b.goToPage(c,Ext.util.History.getHash());a.bind("{language}",b.updateLanguage,b)})},updateLanguage:function(d){var c=this;var b=c.getViewModel().get("topics");var a=b.getRootNode();a.cascadeBy(function(e){e.set("language",d)})},nodeChange:function(c){var b=this;b.lookup("treePanel").setSelection(c);b.updateRoute(c);var a=c.parentNode;while(a){a.expand();a=a.parentNode}},updateRoute:function(a){if(a){this.redirectTo(a.data.id)}},onTreeItemClick:function(a,b){if(b.isExpanded()){b.collapse()}else{b.expand()}},initializeTopics:function(){var d=this;var c=this.getViewModel();if(Deck.util.Global.editing){Ext.toast({title:"Edit Mode",html:"In edit mode, all nodes are read individually<br>to create the tree. Please be patient. :-)",width:300});Ext.Function.defer(a,1,d)}else{Ext.Ajax.request({url:"resources/pages/tree.json",success:function(f){console.log("Using tree.json");var e=Ext.JSON.decode(f.responseText);b(e)},failure:function(){console.log("tree.json does not exist-- loading individual nodes");a()}})}function a(){d.getHiddenArray(function(e){Deck.store.Topics.loadNodes(e).then(function(f){b(f)})},d)}function b(f){var e=Ext.create("Deck.store.Topics",{model:"Deck.model.Node",root:f});c.set("topics",e)}},onNavigate:function(f,b){var d=this.getViewModel();var e=d.get("node");var a;var c;if(e){if(b.keyCode===Ext.event.Event.LEFT){this.lookup("treepanel").getSelectionModel().selectPrevious()}else{if(b.keyCode===Ext.event.Event.RIGHT){if(e.isLeaf()){a=e.nextSibling}else{a=e.firstChild;e.expand()}if(!a){c=e.parentNode;if(c&&!c.isRoot()){a=c.nextSibling}}}}}if(!a){a=d.get("topics").getRoot().firstChild}d.set("node",a)},getHiddenArray:function(b,a){a=a||this;Ext.Ajax.request({url:"resources/pages/hidden/hidden.json",success:function(c){var d=Ext.JSON.decode(c.responseText);b.call(a,d)},failure:function(){b.call(a,null)}})},goToPage:function(e,d){var b=this;if(e){var c=e.findNode(e.getRoot(),d);if(c){var a=b.lookup("treePanel");a.suspendEvents();b.getViewModel().set("node",c);a.resumeEvents()}}}});Ext.define("Deck.view.main.MainViewModel",{extend:"Ext.app.ViewModel",alias:"viewmodel.deck-mainviewmodel",requires:["Deck.model.Node","Deck.store.Topics"],data:{language:"_default"},formulas:{},stores:{}});Ext.define("Deck.view.topics.TopicsMethods",{});Ext.define("Deck.view.topics.TopicsViewController",{extend:"Ext.app.ViewController",alias:"controller.topicsviewcontroller",requires:["Deck.store.Topics","Deck.model.Node","Ext.event.Event"],onArrowClick:function(a){var c=this;var d=c.lookup("searchfield").getValue();var b=(a.getItemId()==="right");c._findPage(d,b)},onSearchFieldKeyUp:function(e,c){var b=this;if(c.getKey()===Ext.event.Event.RETURN){var d=e.getValue();var a=!c.shiftKey;b._findPage(d,a)}},_findPage:function(e,b){var d=this;if(e){var a=d.getViewModel();var c=a.get("topics").findNode(a.get("node"),e,b);a.set("node",c)}}});Ext.define("Deck.view.topics.Topics",{xtype:"deck-topics",extend:"Ext.tree.Panel",mixins:["Deck.view.topics.TopicsMethods"],requires:["Deck.view.topics.TopicsViewController","Deck.util.Global"],controller:"topicsviewcontroller",rootVisible:false,useArrows:true,initComponent:function(){this.callParent(arguments)},tools:[{type:"minus"},{type:"plus"}],bbar:[{xtype:"textfield",flex:1,enableKeyEvents:true,reference:"searchfield",emptyText:"Find topic",listeners:{keyup:"onSearchFieldKeyUp"}},{xtype:"segmentedbutton",allowToggle:false,defaults:{handler:"onArrowClick"},items:[{iconCls:"x-fa fa-arrow-left",itemId:"left"},{iconCls:"x-fa fa-arrow-right",itemId:"right"}]}]});Ext.define("Deck.view.main.Main",{xtype:"deck-main",extend:"Ext.panel.Panel",requires:["Ext.plugin.Viewport","Deck.view.main.MainViewController","Deck.view.main.MainViewModel","Deck.view.topics.Topics","Deck.view.content.Content","Deck.view.edit.Toolbar"],controller:"maincontroller",viewModel:{type:"deck-mainviewmodel"},layout:"border",items:[{xtype:"deck-topics",region:"west",collapsible:true,collapseMode:"mini",titleCollapse:true,reference:"treePanel",split:true,width:200,listeners:{itemclick:"onTreeItemClick"},bind:{store:"{topics}",selection:"{node}"}},{xtype:"deck-content",reference:"content",bind:{node:"{node}"},listeners:{navigate:"onNavigate"},region:"center"}]});